<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Ronnie Payroll Pro v5.0 (Smart)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root { --primary: #2962ff; --bg: #f0f4f8; --card-bg: #ffffff; --text: #333; --red-highlight: #d32f2f; --green: #4caf50; --missing: #ffeb3b; }
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:420px;margin:auto;padding:12px;}
h2{text-align:center;color:var(--primary);margin-bottom:15px;}
.card{background:var(--card-bg);padding:16px;border-radius:16px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,.05); position: relative;}
label{font-size:11px;color:var(--primary);font-weight:bold;display:block;margin-bottom:4px;text-transform:uppercase;}
select, input[type="date"], input[type="number"] {
    width: 100%; height: 48px; padding: 0 12px; font-size: 16px; border-radius: 12px; 
    border: 1.5px solid #d1d9e6; margin-bottom: 12px; box-sizing: border-box; 
    background-color: #fcfcfc; outline: none; color: #333; display: block; -webkit-appearance: none;
}
.btn-save {width: 100%; height: 50px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{color:#90a4ae; padding-bottom:8px; text-align: center;}
td{padding:10px 2px; border-bottom:1px solid #f9f9f9; text-align:center;}
.date-big { font-size: 18px; font-weight: 900; color: #000; display: block; }
.month-small { font-size: 10px; color: #666; font-weight: normal; text-transform: uppercase; }
.holiday-row { background-color: var(--red-highlight) !important; color: white !important; }

/* New Style for Missing Row */
.missing-row { background-color: #fff3e0 !important; color: #e65100 !important; border-left: 4px solid #ff9800; }
.missing-text { font-weight: bold; color: #d32f2f; font-size: 12px; }

.report-card { background: #0a192f; color: #fff; padding: 20px; border-radius: 16px; margin-top: 10px; }
.report-title{font-size:18px;font-weight:bold;margin-bottom:12px;color: var(--green); border-bottom: 1px solid #1e2d4d; padding-bottom: 8px;}
.report-line{display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px;}
.report-val{font-weight:bold; color: #fff;}
.salary-box{background:#112240;padding:15px;border-radius:12px;margin-top:10px;text-align:center;}
.total-amt{font-size:28px;color:var(--green);font-weight:bold;margin:5px 0;}
.calc-btn {width: 100%; height: 48px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: bold; margin: 10px 0; cursor: pointer;}
.back-btn {width: 100%; height: 48px; background: #546e7a; color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 10px; cursor: pointer;}
.photo-btn {width: 100%; height: 48px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;}
.red-btn{background:#d32f2f; width: 100%; height: 35px; color: #fff; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer;}
.show-more-btn { background: #eceff1; color: #546e7a; border: none; width: 100%; padding: 10px; font-weight: bold; border-radius: 8px; margin-top: 10px; cursor: pointer; }
.hide{display:none;}
.exporting .del-col, .exporting .show-more-btn, .exporting .back-btn { display: none !important; }

/* Modal Popup Styles */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 2000; display: flex;
    justify-content: center; align-items: center; visibility: hidden; opacity: 0;
    transition: opacity 0.3s;
}
.modal-overlay.active { visibility: visible; opacity: 1; }
.modal-box {
    background: #fff; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px;
    text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.modal-icon { font-size: 40px; margin-bottom: 10px; display: block; }
.modal-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
.modal-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
.modal-btn { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }

#toast {
    visibility: hidden; min-width: 200px; background-color: #333; color: #fff;
    text-align: center; border-radius: 12px; padding: 16px; position: fixed;
    z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%);
    font-size: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
#toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
@keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
@keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body>

<div id="alertModal" class="modal-overlay">
    <div class="modal-box">
        <span class="modal-icon">‚ö†Ô∏è</span>
        <div class="modal-title">Attention Ronnie!</div>
        <div class="modal-desc">‡§Ü‡§ú‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø (<span id="modalDate"></span>) ‡§ï‡•ã ‡§á‡§®‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§≠‡§è‡§ï‡•ã ‡§õ‡•à‡§®‡•§ ‡§ï‡•á ‡§Ü‡§ú ‡§ï‡§æ‡§Æ ‡§ó‡§∞‡•ç‡§®‡•Å‡§≠‡§Ø‡•ã?</div>
        <button class="modal-btn" onclick="closeModal()">OK, I will fill now</button>
    </div>
</div>

<div class="container">
    <h2>Ronnie Ruchal</h2>
    <div id="toast">‡§°‡§æ‡§ü‡§æ ‡§∏‡•á‡§≠ ‡§≠‡§Ø‡•ã! ‚úÖ</div>

    <div class="card">
        <label>Select Date</label>
        <input type="date" id="inputDate" onchange="autoDetectDay()">
        <label>Day Type</label>
        <select id="dayType" onchange="updateUI()">
            <option value="weekday">Weekday (Mon-Fri)</option>
            <option value="saturday">Saturday</option>
            <option value="sunday">Sunday</option>
            <option value="holiday">Public Holiday</option>
        </select>
        <div id="workedBox" class="hide">
            <label>Worked Today?</label>
            <select id="worked" onchange="updateUI()">
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </div>
        <div id="outBox"><label>Out Time</label><select id="outTime"></select></div>
        <button class="btn-save" onclick="saveEntry()">Save Entry üíæ</button>
    </div>

    <div id="exportArea">
        <div class="card" style="margin-bottom:0; border-radius: 16px 16px 0 0;">
            <label style="margin-bottom:10px;">History (With Missing Check)</label>
            <table>
                <thead><tr><th>Date</th><th>Day</th><th>Basic</th><th>OT</th><th class="del-col">Del</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
            <button id="showMoreBtn" class="show-more-btn" onclick="toggleHistory()">Show More üîΩ</button>
        </div>

        <div id="hourView" class="report-card" style="margin-top:0; border-radius: 0 0 16px 16px;">
            <div class="report-title">Monthly Summary</div>
            <div class="report-line"><span>üìÖ Weekday Basic:</span><span class="report-val" id="hWBasic">0 hrs</span></div>
            <div class="report-line"><span>üóìÔ∏è Saturday Days:</span><span class="report-val" id="hSat">0 d</span></div>
            <div class="report-line"><span>‚òÄÔ∏è Sunday Days:</span><span class="report-val" id="hSun">0 d</span></div>
            <div class="report-line"><span>üéà Holiday Days:</span><span class="report-val" id="hHol">0 d</span></div>
            <div class="report-line"><span>‚öôÔ∏è Normal OT (Hrs):</span><span class="report-val" id="hNormalOT">0.0</span></div>
            <div class="report-line"><span>üåô Night OT (Hrs):</span><span class="report-val" id="hNightOT">0.0</span></div>
            <div class="salary-box"><div class="total-amt">‚Ç© 0</div></div>
        </div>

        <div id="moneyView" class="report-card hide" style="margin-top:0; border-radius: 0 0 16px 16px;">
            <div class="report-title">Salary Breakdown</div>
            <div class="report-line"><span>üìÖ Basic (Mon-Fri):</span><span class="report-val" id="mWBasic">‚Ç© 0</span></div>
            <div class="report-line"><span>‚òÄÔ∏è Sunday Basic:</span><span class="report-val" id="mSunBasic">‚Ç© 0</span></div>
            <div class="report-line"><span>üéà Holiday Basic:</span><span class="report-val" id="mHolBasic">‚Ç© 0</span></div>
            <div class="report-line"><span>‚öôÔ∏è Weekday OT (1.5x):</span><span class="report-val" id="mWOT">‚Ç© 0</span></div>
            <div class="report-line"><span>üóìÔ∏è Saturday OT (1.5x):</span><span class="report-val" id="mSatOT">‚Ç© 0</span></div>
            <div class="report-line"><span>‚òÄÔ∏è Sunday OT (1.5x):</span><span class="report-val" id="mSunOT">‚Ç© 0</span></div>
            <div class="report-line"><span>üéà Holiday OT (1.5x):</span><span class="report-val" id="mHolOT">‚Ç© 0</span></div>
            <div class="report-line"><span>üåô Night Pay (3.0x):</span><span class="report-val" id="mNight">‚Ç© 0</span></div>
            <div class="salary-box">
                <div style="color:#aaa; font-size:12px;">Total Salary Estimate</div>
                <div class="total-amt">‚Ç© <span id="finalSalary">0</span></div>
            </div>
            <button class="back-btn" onclick="switchToHours()">üîô Back</button>
        </div>
    </div>

    <div class="card" style="margin-top:15px;">
        <label>Hourly Rate (‚Ç©)</label>
        <input type="number" id="hourlyRate" value="9860">
        <button class="calc-btn" onclick="calculateSalary()">Calculate Salary ‚Ç©</button>
        <button class="photo-btn" onclick="downloadAsPhoto()">Download Photo üì∏</button>
        <button class="red-btn" onclick="resetAll()">Reset Month</button>
    </div>
</div>

<script>
const STORE_KEY="ronnie_pro_v4.8";
let entries=JSON.parse(localStorage.getItem(STORE_KEY)||"[]");
let showFullHistory = false;
const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
const daysArr = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
const times=["5:30 PM","6:00 PM","6:30 PM","7:00 PM","7:30 PM","8:00 PM","8:30 PM","9:00 PM","9:30 PM","10:00 PM","10:30 PM","11:00 PM","11:30 PM","12:00 AM"];

function showToast() {
    let x = document.getElementById("toast");
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}

function autoDetectDay() {
    let d = new Date(document.getElementById("inputDate").value);
    if(isNaN(d.getTime())) return;
    let dayNum = d.getDay(); 
    let daySelect = document.getElementById("dayType");
    if(dayNum === 0) daySelect.value = "sunday";
    else if(dayNum === 6) daySelect.value = "saturday";
    else daySelect.value = "weekday";
    updateUI();
}

function updateUI(){
    let day=document.getElementById("dayType").value;
    let out=document.getElementById("outTime");
    out.innerHTML="";
    times.forEach(t=>{ let o=new Option(t, t); out.add(o); });
    document.getElementById("workedBox").classList.toggle("hide", day==="weekday");
}

function saveEntry(){
    let date = document.getElementById("inputDate").value;
    if(!date) return alert("‡§Æ‡§ø‡§§‡§ø ‡§∞‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç!");
    if(entries.find(e => e.date === date)) return alert("‡§°‡•á‡§ü‡§æ ‡§™‡§π‡§ø‡§≤‡•ç‡§Ø‡•à ‡§õ!");

    let type = document.getElementById("dayType").value;
    let outVal = document.getElementById("outTime").value;
    let workedVal = (type==="weekday") ? "yes" : document.getElementById("worked").value;
    
    let normalOt = 0, nightOt = 0, basicHrs = 0;
    let [t, m] = outVal.split(' ');
    let [h, min] = t.split(':').map(Number);
    if(h===12) h=(m==='AM')?0:12; else if(m==='PM') h+=12;
    let totalMins = (h*60)+min;

    if (type === "sunday" || type === "holiday") {
        basicHrs = 8;
        if (workedVal === "yes") {
            normalOt = 8;
            nightOt = Math.max(0, (totalMins - 1320) / 60);
        }
    } else if (type === "saturday") {
        if (workedVal === "yes") {
            basicHrs = 0; 
            normalOt = 8 + Math.max(0, (Math.min(totalMins, 1320) - 1050) / 60);
            nightOt = Math.max(0, (totalMins - 1320) / 60);
        }
    } else {
        basicHrs = 8;
        normalOt = Math.max(0, (Math.min(totalMins, 1320) - 1050) / 60);
        nightOt = Math.max(0, (totalMins - 1320) / 60);
    }
    
    entries.push({ date, type, worked:workedVal, normalOt, nightOt, basicHrs });
    entries.sort((a,b)=>new Date(a.date)-new Date(b.date));
    localStorage.setItem(STORE_KEY, JSON.stringify(entries));
    renderHistory();
    showToast();
}

// *** NEW FUNCTION: Fill Gaps for Display ***
function getDisplayList() {
    if(entries.length < 2) return entries;
    
    let fullList = [];
    for(let i=0; i<entries.length; i++) {
        fullList.push(entries[i]);
        
        // Check gap between this and next
        if(i < entries.length - 1) {
            let currDate = new Date(entries[i].date);
            let nextDate = new Date(entries[i+1].date);
            
            // Calculate difference in days
            let timeDiff = nextDate - currDate;
            let diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            // If gap is more than 1 day, insert missing records
            if(diffDays > 1) {
                for(let j=1; j<diffDays; j++) {
                    let missingDate = new Date(currDate);
                    missingDate.setDate(currDate.getDate() + j);
                    fullList.push({
                        date: missingDate.toISOString().split('T')[0],
                        isMissing: true
                    });
                }
            }
        }
    }
    return fullList;
}

function renderHistory(){
    let body=document.getElementById("historyBody");
    body.innerHTML="";
    
    // Get list with gaps filled
    let displayList = getDisplayList();
    
    let entriesToShow = showFullHistory ? displayList : displayList.slice(-5);
    
    let wB=0, nOT=0, niOT=0, sD=0, suD=0, hD=0;
    
    // Calculate totals only from REAL entries
    entries.forEach(e => {
        if(e.type==="weekday") { wB += e.basicHrs; nOT += e.normalOt; }
        else if(e.type==="saturday" && e.worked==="yes") sD++;
        else if(e.type==="sunday" && e.worked==="yes") suD++;
        else if(e.type==="holiday" && e.worked==="yes") hD++;
        niOT += e.nightOt;
    });

    entriesToShow.forEach((e)=>{
        let d = new Date(e.date);
        let tr=document.createElement("tr");
        
        if (e.isMissing) {
            // RENDER MISSING ROW
            tr.className = "missing-row";
            tr.innerHTML = `
                <td><span class="date-big">${e.date.split('-')[2]}</span><span class="month-small">${months[d.getMonth()]}</span></td>
                <td style="font-weight:bold">${daysArr[d.getDay()]}</td>
                <td colspan="2" class="missing-text">MISSING ‚ùå</td>
                <td class="del-col">-</td>
            `;
        } else {
            // RENDER NORMAL ROW
            if(e.type !== "weekday") tr.className = "holiday-row";
            tr.innerHTML=`<td><span class="date-big">${e.date.split('-')[2]}</span><span class="month-small">${months[d.getMonth()]}</span></td>
                          <td style="font-weight:bold">${daysArr[d.getDay()]}</td>
                          <td>${e.basicHrs}</td>
                          <td><b>${(e.normalOt+e.nightOt).toFixed(1)}</b></td>
                          <td class="del-col"><button onclick="delEntry('${e.date}')">üóëÔ∏è</button></td>`;
        }
        body.appendChild(tr);
    });

    document.getElementById("hWBasic").innerText = wB + " hrs";
    document.getElementById("hSat").innerText = sD + " d";
    document.getElementById("hSun").innerText = suD + " d";
    document.getElementById("hHol").innerText = hD + " d";
    document.getElementById("hNormalOT").innerText = nOT.toFixed(1);
    document.getElementById("hNightOT").innerText = niOT.toFixed(1);
}

function calculateSalary() {
    let rate = parseFloat(document.getElementById("hourlyRate").value) || 0;
    let bP=0, suBP=0, hoBP=0, wOT=0, saOT=0, suOT=0, hoOT=0, nP=0;

    entries.forEach(e => {
        if(e.type==="weekday") {
            bP += e.basicHrs * rate;
            wOT += e.normalOt * rate * 1.5;
        } else if(e.type === "sunday") {
            suBP += e.basicHrs * rate;
            if(e.worked === "yes") suOT += e.normalOt * rate * 1.5;
        } else if(e.type === "holiday") {
            hoBP += e.basicHrs * rate;
            if(e.worked === "yes") hoOT += e.normalOt * rate * 1.5;
        } else if(e.type === "saturday" && e.worked === "yes") {
            saOT += e.normalOt * rate * 1.5;
        }
        nP += (e.nightOt * rate * 3.0); 
    });

    document.getElementById("mWBasic").innerText = "‚Ç© " + bP.toLocaleString();
    document.getElementById("mSunBasic").innerText = "‚Ç© " + suBP.toLocaleString();
    document.getElementById("mHolBasic").innerText = "‚Ç© " + hoBP.toLocaleString();
    document.getElementById("mWOT").innerText = "‚Ç© " + wOT.toLocaleString();
    document.getElementById("mSatOT").innerText = "‚Ç© " + saOT.toLocaleString();
    document.getElementById("mSunOT").innerText = "‚Ç© " + suOT.toLocaleString();
    document.getElementById("mHolOT").innerText = "‚Ç© " + hoOT.toLocaleString();
    document.getElementById("mNight").innerText = "‚Ç© " + nP.toLocaleString();
    
    let total = bP + suBP + hoBP + wOT + saOT + suOT + hoOT + nP;
    document.getElementById("finalSalary").innerText = Math.round(total).toLocaleString();
    document.getElementById("hourView").classList.add("hide");
    document.getElementById("moneyView").classList.remove("hide");
}

function switchToHours() {
    document.getElementById("moneyView").classList.add("hide");
    document.getElementById("hourView").classList.remove("hide");
}
function toggleHistory() { showFullHistory = !showFullHistory; renderHistory(); }

// Updated DelEntry to match Date instead of Index (safer for mixed lists)
function delEntry(dateStr){ 
    if(confirm("‡§°‡§ø‡§≤‡§ø‡§ü ‡§ó‡§∞‡•ç‡§®‡•á?")){ 
        let idx = entries.findIndex(e => e.date === dateStr);
        if(idx > -1) {
            entries.splice(idx,1); 
            localStorage.setItem(STORE_KEY, JSON.stringify(entries)); 
            renderHistory(); 
        }
    } 
}
function resetAll(){ if(confirm("‡§∏‡§¨‡•à ‡§∏‡§´‡§æ ‡§ó‡§∞‡•ç‡§®‡•á?")){ entries=[]; localStorage.setItem(STORE_KEY,"[]"); renderHistory(); switchToHours(); } }

function downloadAsPhoto() {
    const area = document.getElementById('exportArea');
    area.classList.add('exporting');
    html2canvas(area, { scale: 2 }).then(canvas => {
        let link = document.createElement('a');
        link.download = `Ronnie_Payroll.png`;
        link.href = canvas.toDataURL();
        link.click();
        area.classList.remove('exporting');
    });
}

// *** AUTO POPUP LOGIC ***
function checkToday() {
    let today = new Date().toISOString().split('T')[0];
    let exists = entries.find(e => e.date === today);
    if(!exists) {
        document.getElementById("modalDate").innerText = today;
        document.getElementById("alertModal").classList.add("active");
    }
}
function closeModal() {
    document.getElementById("alertModal").classList.remove("active");
}

document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
autoDetectDay(); renderHistory();

// Run check after 1 second
setTimeout(checkToday, 1000);

</script>
</body>
</html>
